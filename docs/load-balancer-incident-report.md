# インシデントレポート: ロードバランサーのヘルスチェック設定ミスによる過負荷障害

**日付:** 2025-12-26
**ステータス:** 解決済み
**重要度:** Critical (Tier-1 サービスへの影響)

## 1. 影響を受けたサービスとティア
*   **load-balancer (Tier-1)**: トラフィック振り分けの不全。
*   **api-gateway-2 (Tier-1)**: 誤判定によるサービス離脱。
*   **api-gateway-1 (Tier-1)**: 集中したトラフィックによるリソース枯渇。
*   **order-service (Tier-1)**: 上流の遅延に伴うレイテンシ増大。

## 2. 影響を受けたビジネスフロー
*   **order-processing-flow**: 顧客の注文処理。
*   **inventory-check-flow**: 管理者の在庫確認・更新。

## 3. 顧客への影響
*   **直接的収益損失**: 顧客が購入プロセスを完了できない状態が発生。
*   **ユーザー体験**: フローメタデータの定義に基づき、フロントエンドに「Order processing delayed（注文処理が遅れています）」という縮退メッセージが表示された。

## 4. 障害発生のタイムライン
1.  **[T+0]**: `load-balancer` のヘルスチェック設定ミスが反映される。
2.  **[T+2]**: `api-gateway-2` が「Unhealthy」とマークされ、トラフィックが遮断される。
3.  **[T+3]**: 全トラフィックが `api-gateway-1` に集中。
4.  **[T+5]**: `api-gateway-1` の CPU/メモリが枯渇し、バックエンドへの転送遅延が発生。
5.  **[T+7]**: 監視アラート `Gateway-HighLatency` が発報。

## 5. 修復措置
1.  `load-balancer` のヘルスチェック条件を各インスタンスの `/health` エンドポイントに適合するよう修正。
2.  `api-gateway-2` の Healthy 復帰を確認し、負荷分散を再開。
3.  システムの全エンドポイントのレイテンシが正常値（<200ms）に戻ったことを確認。

## 6. 再発防止策
*   **検証の自動化**: `controls` 内の `ha-config.yaml` 変更時に、ロードバランサー設定の整合性をチェックするテストを導入。
*   **スケーリングポリシーの改善**: `deployment-type: container` の設定を調整し、単一インスタンス脱落時のバースト耐性を強化。
*   **アラートの追加**: 稼働中のゲートウェイインスタンス数が減少した際に早期警告を出すアラートを追加。
