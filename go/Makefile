.PHONY: build format run validate diff difftool clean help setup watch diff-arch d2 watch-d2 check studio

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help:
	@echo "åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:"
	@echo "  make setup     - å¿…è¦ãªãƒ„ãƒ¼ãƒ« (golines) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™"
	@echo "  make build     - Go ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™"
	@echo "  make format    - golines ã‚’ä½¿ç”¨ã—ã¦ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æ•´å½¢ã—ã¾ã™ (120æ–‡å­—åˆ¶é™)"
	@echo "  make run       - ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã—ã¦ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ JSON ã‚’å‡ºåŠ›ã—ã¾ã™"
	@echo "  make validate  - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ç”Ÿæˆã—ã€CALM ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™"
	@echo "  make check     - Go DSL ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«ã‚’å®Ÿè¡Œã—ã¾ã™"
	@echo "  make test      - ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™"
	@echo "  make test-coverage - ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç¢ºèªã—ã¾ã™"
	@echo "  make diff      - æ—¢å­˜ã® ecommerce-platform.json ã¨ã®å·®åˆ†ã‚’ç¢ºèªã—ã¾ã™"
	@echo "  make difftool  - æ—¢å­˜ã® ecommerce-platform.json ã¨ã®å·®åˆ†ã‚’ç›®ã§ç¢ºèªã—ã¾ã™"
	@echo "  make diff-arch - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æ„å‘³çš„ãªå·®åˆ†ã‚’è¡¨ç¤ºã—ã¾ã™"
	@echo "  make d2        - D2 ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ ã‚’ç”Ÿæˆã—ã¾ã™"
	@echo "  make watch     - ãƒ©ã‚¤ãƒ–ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã§è‡ªå‹•æ›´æ–° (Mermaid)"
	@echo "  make watch-d2  - ãƒ©ã‚¤ãƒ–ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã§è‡ªå‹•æ›´æ–° (D2)"
	@echo "  make studio    - CALM Studio (åŒæ–¹å‘ã‚¨ãƒ‡ã‚£ã‚¿) ã‚’èµ·å‹•ã—ã¾ã™"
	@echo "  make clean     - ç”Ÿæˆã•ã‚ŒãŸãƒã‚¤ãƒŠãƒªã‚„ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™"

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—: å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
setup:
	go install github.com/segmentio/golines@latest
	@echo "D2ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: brew install d2"

# ãƒ“ãƒ«ãƒ‰: å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
build:
	go build -o ../arch-gen ./cmd/arch-gen

# ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: golines ã§ 120 æ–‡å­—åˆ¶é™ã‚’é©ç”¨ã—ã¦æ•´å½¢
format:
	@command -v golines >/dev/null 2>&1 || (echo "golines ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚make setup ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" && exit 1)
	golines -w -m 120 --base-formatter gofmt .

# å®Ÿè¡Œ: JSON ã‚’æ¨™æº–å‡ºåŠ›ã«æ›¸ãå‡ºã—
run:
	@go run ./cmd/arch-gen

# ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: JSON ã‚’ç”Ÿæˆã—ã¦ calm validate ã‚’å®Ÿè¡Œ
validate:
	@go run ./cmd/arch-gen > generated-arch.json
	calm validate -a generated-arch.json
	@rm generated-arch.json

# Go DSL ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: å†…è”µãƒ«ãƒ¼ãƒ«ã‚’å®Ÿè¡Œ
check:
	@go run ./cmd/arch-gen -validate

# ãƒ†ã‚¹ãƒˆ: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
test:
	go test ./...

# ã‚«ãƒãƒ¬ãƒƒã‚¸: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç¢ºèª
test-coverage:
	go test -coverprofile=coverage.out ./...
	go tool cover -func=coverage.out

# æ¯”è¼ƒ: æ—¢å­˜ã® ecommerce-platform.json ã¨ã®å·®åˆ†ã‚’ç¢ºèª
diff:
	@jq -S . ../architectures/ecommerce-platform.json > /tmp/expected.json
	@go run ./cmd/arch-gen > /tmp/raw_actual.json
	@jq -S . /tmp/raw_actual.json > /tmp/actual.json
	diff -u /tmp/expected.json /tmp/actual.json || true
	@rm /tmp/expected.json /tmp/actual.json /tmp/raw_actual.json

# æ¯”è¼ƒ: æ—¢å­˜ã® ecommerce-platform.json ã¨ã®å·®åˆ†ã‚’ç¢ºèª
difftool:
	@jq -S . ../architectures/ecommerce-platform.json > /tmp/expected.json
	@go run ./cmd/arch-gen > /tmp/raw_actual.json
	@jq -S . /tmp/raw_actual.json > /tmp/actual.json
	nvim -d /tmp/expected.json /tmp/actual.json
	@rm /tmp/expected.json /tmp/actual.json /tmp/raw_actual.json

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—: ç”Ÿæˆç‰©ã‚’å‰Šé™¤
clean:
	rm -f ../arch-gen generated-arch.json architecture.d2 coverage.out

# ãƒ©ã‚¤ãƒ–ã‚µãƒ¼ãƒãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’ç›£è¦–ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã‚’è‡ªå‹•æ›´æ–° (Mermaid)
watch:
	@echo "ğŸš€ Starting live server (Mermaid)..."
	@cd cmd/watch && go run . ../..

# ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å·®åˆ†: æ„å‘³çš„ãªå·®åˆ†ã‚’è¡¨ç¤º
diff-arch:
	@go run ./cmd/arch-gen > /tmp/new-arch.json
	@cd cmd/diff && go run . ../../../architectures/ecommerce-platform.json /tmp/new-arch.json

# D2 ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ ç”Ÿæˆ
d2:
	@go run ./cmd/arch-gen -format d2 > architecture.d2
	@echo "âœ… Generated architecture.d2"
	@command -v d2 >/dev/null 2>&1 && d2 architecture.d2 architecture.svg && echo "âœ… Generated architecture.svg" || echo "ğŸ’¡ Install d2 to generate SVG: brew install d2"

# D2 ãƒ©ã‚¤ãƒ–ã‚µãƒ¼ãƒãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’ç›£è¦–ã—ã¦D2ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ ã‚’è‡ªå‹•æ›´æ–°
watch-d2:
	@echo "ğŸš€ Starting D2 live server..."
	@command -v d2 >/dev/null 2>&1 || (echo "âŒ d2 ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚brew install d2 ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" && exit 1)
	@cd cmd/watch && go run . -d2 ../..

# CALM Studio: åŒæ–¹å‘ã‚¨ãƒ‡ã‚£ã‚¿ (Go DSL â†” D2)
studio:
	@echo "ğŸ¨ Starting CALM Studio..."
	@command -v d2 >/dev/null 2>&1 || (echo "âŒ d2 ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚brew install d2 ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" && exit 1)
	@cd cmd/studio && go run . ../..
