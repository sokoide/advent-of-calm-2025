# CALM Architecture Definition in Go & Studio

このディレクトリには、CALM アーキテクチャを Go で定義・生成するための DSL 実装と、それを視覚的に操作するための **CALM Studio (GUI)** が含まれています。

## 概念：DSL と GUI の融合 — 「最高の書き心地」と「最高の見通し」

静的な JSON を手書きする時代は終わりました。本プロジェクトでは、Go 言語の堅牢な **ロジック (DSL)** と、直感的な **視覚操作 (GUI)** をシームレスに同期させることで、アーキテクチャ設計を「退屈なドキュメント作成」から「エキサイティングな開発体験」へと進化させます。

### なぜ Go で書くのか？ — 構成（Config）から開発（Coding）へ
静的な JSON や YAML の編集は「作業」になりがちですが、Go DSL を使うことで設計は「創造的な開発」になります。
- **圧倒的な書き心地 (DX)**: 強力な IDE の補完、リファクタリング、定義へのジャンプなど、モダンな開発環境の恩恵をフルに受けられます。
- **「実行するまでエラーがわからない」からの脱却**: Typo や型違いはエディタが即座に指摘し、不整合はビルド時に検出されます。
- **ロジックによる表現**: ループや条件分岐、変数を駆使することで、巨大なシステムも簡潔かつ知的に記述できます。
- **なによりも、楽しい**: 「巨大な JSON と格闘する」ストレスから解放され、「Go でスマートに設計図を組む」楽しさを享受できます。

---

## 主な機能とメリット

### 1. 双方向同期 (Bidirectional Sync)
単なる一方向の生成ではありません。
- **Go ➔ Diagram**: コードを保存した瞬間に図面が更新されます (Hot Reload)。
- **Diagram ➔ Go**: GUI 上でのノード追加や名前変更が、Go ソースコード (AST) へ直接反映されます。
- **JSON ➔ Go (Reverse Conversion)**: 生成された CALM JSON を直接編集し、**Diff 確認モーダル** を経て安全に Go DSL へ書き戻すことができます。

### 2. 階層構造の完全サポート
`Order Database Cluster` や `Message Broker` のような複雑な入れ子構造を、D2 および React Flow の両方で再帰的に正しくレンダリングします。グループを移動すれば、中身の子ノードも追随します。

---

## なぜ JSON 直接編集より優れているのか？

| 比較項目 | CALM 標準 JSON (手書き) | Go DSL + CALM Studio |
| :--- | :--- | :--- |
| **整合性** | ID の Typo や重複が実行までわからない。 | **コンパイル時とリアルタイムバリデーション**で完全保証。 |
| **スケーリング** | 10台の増強に10箇所のコピペが必要。 | **定数を変えるだけ**。配線やフローも自動生成。 |
| **視認性** | 数千行の JSON から全体像を把握するのは困難。 | **常に横に図面がある**。視覚とコードが一致する安心感。 |
| **レイアウト** | 座標を手入力するのは苦行。 | **GUI でドラッグ＆ドロップ**。座標は自動保存。 |
| **安全性** | 誤った置換でファイル全体が壊れるリスク。 | **AST 解析と Diff プレビュー**による安全な更新。 |

---

## DSL 命名規則 (Naming Conventions)

| 接頭辞 / メソッド | 役割 | 説明 | 例 |
| :--- | :--- | :--- | :--- |
| **`New...`** | **独立した部品の生成** | 親が決まっていない単体の部品を作成します。 | `NewRequirement`, `NewSecurityConfig` |
| **`Define...`** | **宣言的生成 (Modern)** | Functional Options を受け取り、ノード等を生成します。 | `arch.DefineNode()`, `arch.DefineFlow()` |
| **`With...`** | **オプション設定** | `Define...` メソッドに渡すための設定関数です。 | `WithOwner()`, `WithMeta()` |
| **`ConnectTo`** | **ノード中心の接続** | ノード自身から接続を開始し、Builder を返します。 | `node.ConnectTo(dest)` |
| **`Via` / `Is` / `Encrypted`** | **属性の設定 (Fluent)** | プロパティを流れるように設定します。 | `rel.Via("src", "dst").Encrypted(true)` |
| **`Merge`** | **メタデータの合成** | 複数のマップを一つにまとめます。衝突時はパニックします。 | `Merge(metaTier1, metaOps)` |

---

## 開発者向けツール

### CALM Studio の起動
以下のコマンドで、フロントエンドのビルドとサーバーの起動が自動で行われます。
```bash
make studio
```
起動後、ブラウザで `http://localhost:3000` を開き、以下のタブを操作してください。
- **Merged**: Go エディタと Diagram の分割表示（標準モード）。
- **Diagram**: React Flow によるインタラクティブな編集。
- **CALM JSON**: JSON の確認と Go への「逆変換」。
- **D2 Diagram**: D2 エンジンによる高精細な図面表示。

### Local Agent + Studio の起動
ローカルの Go/D2 ツールチェーンを優先利用したい場合は、以下で同時起動します。
```bash
make studio-local
```
`studio-local` はログに `agent:` / `studio:` のプレフィックスを付けて表示します。

#### Local Agent の意義
- **サーバー負荷の集中を避ける**: 変換（Go DSL → JSON/D2）やSVG生成はクライアント側で実行し、サーバーは保存と配信に集中できます。
- **ローカルのGo/D2を活用**: 各ユーザーのGoコンパイラとD2 CLIで変換・SVG生成を行うため、全体のスループットが上がります。

### その他のターゲット
| コマンド | 説明 |
| :--- | :--- |
| **`make format`** | `golines` を使用して Go コードを整形します (120文字制限)。 |
| **`make check`** | 所有者設定やバックアップ設定などの設計ルールを検証します。 |
| **`make validate`** | 生成された JSON が CALM スキーマに準拠しているか検証します。 |
| **`make diff-arch`** | 2 つのアーキテクチャ間の意味的な差分をカラー表示します。 |
| **`make d2`** | 静的な D2 ソースと SVG を一括生成します。 |
| **`make test`** | ユニットテストを実行します。 |

---

## 総評：設計を「プログラミング」する価値

今回の Go DSL ↔ Studio の統合は、単なるツールの作成ではありません。**「動くコード（実装）」と同じ熱量で「語るコード（設計図）」を書けるようにすること**が真の目的です。

人間が手作業で整合性を保つストレスから解放され、Go の表現力を借りてシステムの構造をスマートに解き明かしていく。この「創造的な開発体験」こそが、CALM Studio が提供する最大の価値です。
